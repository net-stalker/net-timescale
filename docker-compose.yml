version: '3.8'

#https://docs.docker.com/desktop/networking/#i-want-to-connect-from-a-container-to-a-service-on-the-host
#the special DNS name host.docker.internal which resolves to the internal IP address used by the host
services:
  net-agent:
    hostname: net-agent
    build:
      context: .
      args:
        PROJ_NAME: net-agent
    environment:
      HOST: net-hub
    networks:
      - skynet

  net-hub:
    hostname: net-hub
    build:
      context: .
      args:
        PROJ_NAME: net-hub
    networks:
      - skynet

  net-translator:
    hostname: net-translator
    build:
      context: .
      args:
        PROJ_NAME: net-translator
    networks:
      - skynet

  net-timescale:
    hostname: net-timescale
    build:
      context: .
      args:
        PROJ_NAME: net-timescale
    networks:
      - skynet

  # https://docs.timescale.com/install/latest/installation-docker/
  # To run container execute command: docker-compose up timescaledb
  # To check that timescaleDB is up execute command: nc -vz localhost 5432
  # Connect to timescaleDB execute command: psql -U postgres -h localhost
  # or you can use https://dbeaver.io/
  timescaledb:
    #    image: timescale/timescaledb-pg14-latest
#    image: timescale/timescaledb-ha:pg14-latest
    build:
      context: ./net-timescale/timescaledb
    hostname: timescaledb
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_PASSWORD=PsWDgxZb
    #    -v /your/data/dir:/home/postgres/pgdata/data \
    networks:
      - skynet

  timescaledb-migrations:
    build:
      context: ./net-timescale/migrations
    container_name: timescaledb-migrations
    environment:
      # https://docs.liquibase.com/parameters/home.html
      - LIQUIBASE_COMMAND_URL=jdbc:postgresql://timescaledb:5432/postgres
      - LIQUIBASE_COMMAND_USERNAME=liquibase
      - LIQUIBASE_COMMAND_PASSWORD=PsWDgxZb
      - LIQUIBASE_LOG_LEVEL=INFO
    depends_on:
      - timescaledb
    networks:
      - skynet

networks:
  skynet:
    driver: bridge
